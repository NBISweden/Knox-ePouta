% \beginpgfgraphicnamed{overview}
\begin{tikzpicture}
  [vm/.append style={drop shadow}]  
  %\draw[help lines] (0,0) grid (3,2);

  \draw[rounded corners,thick]%
  (0,0) to[bend left=15]
  coordinate[pos=0]    (vm1-epouta)
  coordinate[pos=0.25] (vm2-epouta)
  coordinate[pos=0.5]  (vm3-epouta)
  coordinate[pos=0.75] (dhcp-epouta)
  ++(1.5,-5) to
  node[pos=0.3,link] (link) {1 Gb/s}
  coordinate[pos=0.7] (router)
  coordinate[pos=0.87] (dhcp-knox)
  ++(-6,0) to[bend left=15]
  coordinate[pos=0.01] (supernode)
  coordinate[pos=0.25] (storage)
  coordinate[pos=1]    (vm1-knox)
  coordinate[pos=0.75] (vm2-knox)
  coordinate[pos=0.5]  (vm3-knox)
  ++(-0.5,5);

  \path[every pin/.style={vm},pin distance=2ex,every pin edge/.style={thick,bend left=10,auto}]
  % 
  (vm1-epouta)  node[connector,pin=right:{VM$_1$\nodepart{two}10.101.0.21}] {}
  (vm2-epouta)  node[connector,pin=right:{VM$_2$\nodepart{two}10.101.0.22}] {}
  (vm3-epouta)  node[connector,pin=right:{VM$_3$\nodepart{two}10.101.0.23}] {}
  (dhcp-epouta) node[connector,pin=right:{DHCP\nodepart{two}10.101.0.3}] {}
  (router)      node[connector,pin=above:{Router\nodepart{two}10.101.0.1}] {}
  (dhcp-knox)   node[connector,pin=below:{DHCP\nodepart{two}10.101.128.0}] {}
  (supernode)   node[connector,pin=left:{Supernode\nodepart{two}10.101.128.100}] {}
  (storage)     node[connector,pin=left:{Storage\nodepart{two}10.101.128.104}] {}
  (vm1-knox)    node[connector,pin=left:{VM$_1$\nodepart{two}10.101.128.101}] {}
  (vm2-knox)    node[connector,pin=left:{VM$_2$\nodepart{two}10.101.128.102}] {}
  (vm3-knox)    node[connector,pin=left:{VM$_3$\nodepart{two}10.101.128.103}] {}
  ;


  \path[name path=border] (link) -- ++(120:65mm) node[right=6ex,pos=0.5](fin){Finland} node[left=4ex,pos=0.4](swe){Sweden};
  \path [name path=limit] (vm1-epouta) -- (vm1-knox);
  \path [name intersections={of=border and limit, by=t},] (link) -- (t);

  %% Extend a bit
  \path (link) coordinate(b);
  \path (b) ++(right:35mm) coordinate(b-l);
  \path (b) ++(left:65mm) coordinate(b-r);
  \path (t) ++(right:65mm) coordinate(t-l);
  \path (t) ++(left:35mm) coordinate(t-r);
  

 
  \begin{pgfonlayer}{my background}
     % \draw (-3,0) rectangle +(10,-5);
     % \foreach \n in {t,t-l,t-r,b,b-l,b-r}{ \node[circle] at (\n){\n}; }
    \clip (3,0) rectangle +(-10,-5);

    \shade[left color=blue!20,right color=white]%
    (b) decorate[decoration={snake,segment length=6ex, amplitude=0.5ex}]{ -- (t) }
    decorate[decoration=lineto] { -- (t-l) -- (b-l) -- cycle };

    \shade[right color=yellow!50,left color=white]%
    (b) decorate[decoration={snake,segment length=6ex, amplitude=0.5ex}]{ -- (t) }
    decorate[decoration=lineto] { -- (t-r) -- (b-r) -- cycle };
  \end{pgfonlayer}



  %% SWE Flag
  \begin{scope}[shift={(swe.west)},scale=0.1]
    %% Poteau
    \draw[fill=black] (-.2,0) to [bend right] (.2,0) -- (.2,8) to [bend left] (-.2,8) -- cycle;
    \draw[fill=black] (0,8) circle (.4) ;
    \begin{scope}
      %% Flag contour
      \clip
      (0.2,7.6)
      .. controls +(60:20mm) and +(-160:60mm) ..
      coordinate[pos=.55] (t1) coordinate[pos=.65] (t2)
      (8,9)
      to[out=-85 ,in=85]
      coordinate[pos=.3] (r1) coordinate[pos=.45] (r2)
      (7.5,4) 
      .. controls +(-140:30mm) and +(20:30mm) .. 
      coordinate[pos=.7] (b1) coordinate[pos=.6] (b2)
      (.2,3)
      to [out =85,in=-80]
      coordinate[pos=.7] (l1) coordinate[pos=.5] (l2)
      cycle;
      %% Background
      \path[fill=blue] 
      (0.2,7.6)
      .. controls +(60:20mm) and +(-160:60mm) ..
      (8,9)
      to[out=-85 ,in=85]
      (7.5,4) 
      .. controls +(-140:30mm) and +(20:30mm) .. 
      (.2,3)
      to [out =85,in=-80]
      cycle;
      %% Stripes
      \path[fill=yellow] (l1) .. controls +(60:20mm) and +(-160:60mm) .. (r1) -- (r2) .. controls +(-160:60mm) and +(60:20mm) .. (l2) -- cycle;
      \path[fill=yellow] (t1) to[in=85,out=-80] (b1) -- (b2) to[out=85,in=-80] (t2) -- cycle;
    \end{scope}
  \end{scope}


  %% FIN Flag
  \begin{scope}[shift={(fin.west)},scale=0.1]
    %% Poteau
    \draw[fill=black] (-.2,0) to [bend right] (.2,0) -- (.2,8) to [bend left] (-.2,8) -- cycle;
    \draw[fill=black] (0,8) circle (.4) ;
    \begin{scope}
      %% Flag contour
      \clip
      (0.2,7.6)
      .. controls +(60:20mm) and +(-160:60mm) ..
      coordinate[pos=.55] (t1) coordinate[pos=.65] (t2)
      (8,9)
      to[out=-85 ,in=85]
      coordinate[pos=.3] (r1) coordinate[pos=.45] (r2)
      (7.5,4) 
      .. controls +(-140:30mm) and +(20:30mm) .. 
      coordinate[pos=.7] (b1) coordinate[pos=.6] (b2)
      (.2,3)
      to [out =85,in=-80]
      coordinate[pos=.7] (l1) coordinate[pos=.5] (l2)
      cycle;
      %% Background
      \path[fill=white] 
      (0.2,7.6)
      .. controls +(60:20mm) and +(-160:60mm) ..
      (8,9)
      to[out=-85 ,in=85]
      (7.5,4) 
      .. controls +(-140:30mm) and +(20:30mm) .. 
      (.2,3)
      to [out =85,in=-80]
      cycle;
      %% Stripes
      \path[fill=blue] (l1) .. controls +(60:20mm) and +(-160:60mm) .. (r1) -- (r2) .. controls +(-160:60mm) and +(60:20mm) .. (l2) -- cycle;
      \path[fill=blue] (t1) to[in=85,out=-80] (b1) -- (b2) to[out=85,in=-80] (t2) -- cycle;
    \end{scope}
  \end{scope}


\end{tikzpicture}
% \endpgfgraphicnamed
